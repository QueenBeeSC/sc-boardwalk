<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html"> -->
<link rel="import" href="../sc-shh/sc-shh.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">



<!--
`sc-eavesdropper` is a component to snoop on whisper channels

@demo src/sc-eavesdropper/demo/index.html 
-->
<dom-module id="sc-eavesdropper">
  <template>
<!--     <app-location route="{{route}}" use-hash-as-path></app-location>  
    <app-route route="{{route}}" pattern=":page/:hashtag" data="{{routedata}}" tail="{{pageTail}}"></app-route>
 -->    <sc-shh web3="{{web3}}"></sc-shh>

		<img src="./eavesdropping.gif">
Enter hashtag to snoop <paper-input value="{{hashtag}}">
<div>
<template is="dom-repeat" items="{{messages}}">
<li><pre>{{_tostring(item)}}</pre></li>
</template>
</div>


    </template>
 	<script>
    Polymer({
    	is: 'sc-eavesdropper',
    	properties: {
    		messages: {
    			type: Array,
    			value: [],
    		},
    	},
    	observers: [
    		'_openwhisperchannel(hashtag,web3)'
    	],
    	attached: function() {
    		console.log('sc-eavesdropper -> ready.', this.routedata);
    	},
    	detached: function(){
    		this._stophastaglistener();
    	},

    	_openwhisperchannel: function() {
    		if (!this.web3 || !this.hashtag) {
    			return;
    		}
    		console.log('start listening to', this.hashtag);
    		this._starthastaglistener();
    	},

    	_tostring: function(o) {
    		return JSON.stringify(o);
    	},

    	_stophastaglistener: function(){
    		if (this.filter){
    			this.filter.stopWatching();
    		}
    	},

    	_starthastaglistener: function() {

    		this._stophastaglistener();

    		var self = this;
    		if (this.web3 && this.hashtag) {

    			this.filter = self.web3.shh.filter({
    				"hashtags": [self.web3.fromAscii(this.hashtag)],
    			});

    			console.log("sc-whisperer: channelswitch, start listening to", this.hashtag);
    			this.filter.watch(this._processmessage.bind(this));
    		}
    	},

    	// processinging of channel setup messages.
    	_processmessage: function(error, result) {
    		console.log('incoming in whisperer: web3 ', this.web3);
    		var self = this;
    		var payload = JSON.parse(self.web3.toAscii(result.payload));
    		this.dispatch('add', payload);
    	},



    });
      </script>    
    </dom-module>