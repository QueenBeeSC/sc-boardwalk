<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/sc-style/sc-style.html">
<link rel="import" href="../../bower_components/sc-iconset/sc-iconset.html">
<link rel="import" href="../sc-payout/sc-payout.html">
<link rel="import" href="../sc-avatar/sc-avatar.html">
<link rel="import" href="../sc-username/sc-username.html">
<link rel="import" href="../sc-loader/sc-loader.html">
<link rel="import" href="../sc-dealchat/sc-dealchat.html">
<link rel="import" href="../sc-redux/sc-redux.html">
<link rel="import" href="../sc-shh/sc-shh.html">
<link rel="import" href="../sc-config/sc-config.html">
<link rel="import" href="../sc-helpers/sc-helpers.html">
<link rel="import" href="../sc-hashtagcontract/sc-hashtagcontract.html">
<link rel="import" href="../sc-dealfortwo/sc-dealfortwo.html">

<!--<link rel="import" href="../sc-balance/sc-balance.html"> -->


<!--
`sc-dealfortwo-provider`

This components allows 2 Swarm Citizens to make a deal with eachother, based on the request of the service-seeker.

@demo src/sc-dealfortwo-provider/demo/index.html 
-->

<dom-module id="sc-dealfortwo-provider">

  <template>
   <style include="sc-styles">
     :host {
        display: block;
        height: 100%;
        width: 100%;
      }

      neon-animated-pages {
        height: 100%;
        width: 100%;
      }

      .fullheight {
        height: 100%;
      }

      .topbar {
        height: 10vh;
      }

      .totalbox {
        width: 100%;
      }

      .tophalf {
        min-height: 55vh;
        padding: 8vh 10vw 0px 10vw;
        @apply(--layout-vertical);
        @apply(--layout-start-justified);
        @apply(--layout-start);  
      }

      .tophalf h1 {
        font-size: 40px;
        line-height: 44px;
        max-width: 800px;
      }

      .withconfirmq {
        min-height: 50vh;
      }
/*
      sc-avatar {
        margin-right: 10px;         
      }*/

      .bottomhalf {
        height: 35vh;
        box-sizing:border-box;
        padding: 0px 10vw 0px 10vw;
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        @apply(--layout-center);  
      }



      .accepter {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-start-justified);
        @apply(--layout-center);        
      }

/*
      .box {
        width: 50%;
      }


      .amountwaiting {
        opacity: 0.15;
      }


      .amountconfirmed {
        opacity: 1;
      }



      .dealamountio {
        margin-top: 10px;
        margin-left: -35px;
        margin-right: -35px;        
        @apply(--layout-vertical-reverse);
        @apply(--layout-center-center);
      }

      .dealamountio p {
        font-size: 22px;
        line-height: 24px;
        margin-top: 10px;
      }
*/
      .SWTletters {
        font-size: 10px;
        line-height: 12px;   
      }

      sc-dealchat {
        width: 100%;
        height: 100%;
      }



      .announce { 
        box-sizing:border-box;
        padding: 4vw 0px 2vw 0px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-start-justified);
      }


      .details_toggler { 
        /*text-decoration: underline;*/        
        border-bottom: 1px dotted var(--sc-grey3);
        font-size: 14px;
        line-height: 14px;   
      }


      #details_collapser {
        width: 100%;   
      }


      .details_collapser_inner {
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-start);
        @apply(--layout-start-justified);
        border-top: 1px dotted var(--sc-grey2);
        border-bottom: 1px dotted var(--sc-grey2); 
        box-sizing:border-box;
        padding: 15px 0px;
        margin-bottom: 25px;       
      }

      .announce paper-button{ 
        margin-left: 2vw;        
      }


      .confirmbtns {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-end-justified);  
        margin-left: 2vw;        
      
      }

      paper-icon-button.confirmbtn {
          /*margin-top: -40px;*/
          margin-right: 6vw;
          width: 80px;
          height: 80px;
      }

      paper-icon-button.confirmbtn.blue {
          background-color: #36B7FF;
          box-sizing:border-box;
          padding: 8px;
      } 

      paper-icon-button.confirmbtn.green {
          background-color: #8ADEA9;
      }

      paper-button.blue {
          background-color: #36B7FF;
      } 


      .dealid {
        font-size: 36px;
        line-height: 40px;        
      }

      .avatars_funding {
        box-sizing:border-box;
        padding: 0px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-start-justified); 
        margin-bottom: 2vw;
       
      }


      .avatar_funding {
        box-sizing:border-box;
        padding: 0px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-start-justified);
        margin-right: 10px;        
      }

      .divider {
        height: 100%;
        width: 2px;
        border-left: 2px dotted var(--sc-grey2);
        margin: 0px 50px;
      }


      .funding {
        margin-left: 12px;
      }

      .funding p {
        font-size: 40px;
        line-height: 42px;
      }

      .swtletters {
        font-size: 16px;
        line-height: 20px;       
      }

/*      .v_icon {
        margin: 12px 0px 0px 6px;
      }*/

      .fund_init p {
        opacity: 0.35;
        color: var(--sc-grey2);
      }


      .fund_init iron-icon {
        opacity: 0.35;
        color: var(--sc-grey2);
      }

      .fund_accepted p {
        opacity: 1;
        color: var(--sc-grey3);
      }

      .fund_accepted iron-icon {
        opacity: 1;
        color: var(--sc-green);
      }

/*      .request_msg {
        font-size: 24px;
        line-height: 36px;
      }*/

      .replyer_username {
        border-bottom: 1px dotted var(--sc-blue);
      }

      .announce_amount {
        font-size: 12px;
        line-height: 16px;
      }

      .acceptbtn {
        padding: 18px 22px 18px 34px;
        margin-right: 30px; 
      }

      .dealmsg {
        box-sizing:border-box;
        padding: 10px 0px;


      }

      .decliner {
        opacity: 0.65;
        margin-right: 10px;
      }

      .confirmation_question {
        font-size: 24px;
        line-height: 26px; 
        text-align: right;
      }


    @media all and (min-width: 0) and (max-width: 420px) { 


      .tophalf {
        min-height: 50vh;
        padding: 6vh 12vw 0px 12vw;
        @apply(--layout-vertical);
        @apply(--layout-start-justified);
        @apply(--layout-start);  
      }


      .bottomhalf {
        min-height: 40vh;
        @apply(--layout-vertical);
        @apply(--layout-center); 
        @apply(--layout-start-justified);
      }


      .announce {
        box-sizing:border-box;
        padding: 11vw 0px 2vw 0px;
      }

      .tophalf h1 {
          font-size: 32px;
          line-height: 38px;
        }

      .confirmbtns {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);        
      }

      paper-icon-button.confirmbtn {
          width: 72px;
          height: 72px;
          padding: 14px;
      }


      .funding p {
        font-size: 24px;
        line-height: 26px;
      }


      .v_icon {
        margin: 0px 0px 0px 6px;
      }

      .confirmation_question {
        margin: 40px 0px 30px 0px;
        font-size: 18px;
        line-height: 22px; 
        width: 80%; 
        text-align: center;
      }

      .avatars_funding {
        box-sizing:border-box;
        padding: 0px;
/*        @apply(--layout-vertical);
        @apply(--layout-start);
        @apply(--layout-start-justified); */
        margin-bottom: 2vw;
       
      }

    }



    </style>
    <sc-shh web3="{{shhweb3}}"></sc-shh>
    <sc-config config="{{config}}"></sc-config>
    <!--<sc-helpers id="helpers"></sc-helpers>    
    <sc-hashtagcontract id="hashtagcontract" hashtagname="{{data.hashtag}}"></sc-hashtagcontract>   -->  
    <iron-media-query query="(min-width:0px) and (max-width: 420px)" query-matches="{{phoneview}}"></iron-media-query>

    <app-route route="{{route}}" pattern="/:hashtag/:requestid/:replyid" data="{{routedata}}"></app-route>

    <blink>
    FUND "{{requestdata.msg}}" ... with {{requestdata.seeker.username}} by sending {{requestdata.amount}} SWT to the dealaddress {{requestdata.dealaddress}} ?
     <paper-icon-button icon="sc-icons:v" noink class="confirmbtn blue big white shadow" on-tap="fundThisDeal"></paper-icon-button>


    </blink>

  </template>

  <script>

    Polymer({

      is: 'sc-dealfortwo-provider',

      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        ReduxBehaviour
      ],

      observers: [
     
      ],


      properties: {
        /**
       * `prop1` this is the first property and what it does is described right here.
       */
        identity: {
          type: Object,
          statePath: 'identity',
        },
        route: {
          type: Object,
          observer: '_getdata'
        },        
        deals: {
          type: Array,
          statePath: 'deals',
          observer: '_getdata'
        },
      },

      _getdata: function(){
        

        if (!this.routedata){
          return;
        }

        var self = this;
        if (!this.deals || !this.routedata.requestid || !this.routedata.replyid){
          return;
        }
        
        var request = this.deals.find(function(item){
            return item.id === self.routedata.requestid;
        });

        this.requestdata = request;

        if (request && request.replies){
          var reply = request.replies.find(function(item){
            return item.id === self.routedata.replyid;
          });
          this.replydata = reply;

        }else{
          //debugger;
          console.error('what now.. ?');
        }
      },

      fundThisDeal: function() {
        var self = this;

        var offerAmount = this.requestdata.amount;
        var dealaddress = this.requestdata.dealaddress;
        var dealID = this.requestdata.id;

        debugger;

        self.transfer(offerAmount, dealaddress, function(err, res) {

          // ok so the create deal TX is done. Now notify that we're funding this deal.
          var payload = {
            id: dealID,
            type: 'dealfortwo-provider-funding',
            time: Date.now(),
            offerseekerfundingtx: res,
            dealaddress: dealaddress,
          };

          var topics = [
            self.shhweb3.encodetopic("swarmcity-v1"),
            self.shhweb3.encodetopic(payload.type),
            self.shhweb3.encodetopic(self.requestdata.hashtag),
            self.shhweb3.encodetopic(payload.id),
          ];

          if (self.shhweb3) {

            var options = {
              "from": self.shhweb3.identity,
              "topics": topics,
              "payload": self.shhweb3.fromAscii(JSON.stringify(payload)),
              "ttl": 60 * 60 * 24,
              "priority": 1000
            };

            console.log('posting to topics', topics);

            return self.shhweb3.shh.post(options, function(err, res) {
              console.log(err, res);
              //self.fire('new-submitted', {dealid:newrequest.id});
            });
          }
        });

      },

      /**
      * 'transfer' does the actual transfer by calling the SWT-contract and using its sendTransaction-function.
      */
      transfer: function(amount, pubkey, cb) {
        var self = this;
        //this.sendcoinstate = 'sending';
        this.contracturl = this.resolveUrl('../contracts/MiniMeToken.json');
        this.importHref(this.contracturl, function(e) {
          this.contractjson = JSON.parse(e.target.import.body.innerText);
          self.web3.eth.getGasPrice(function(err, result) {
            var gasPrice = result.toNumber(10);
            // console.log('gasprice: ', gasPrice);
            var MyContract = self.web3.eth.contract(self.contractjson.abi);
            var myContractInstance = MyContract.at(self.config.swttokencontractaddress);
            console.log('doing transfer of ', amount, ' LC to: ', pubkey, 'from: ', self.identity.pubkey,);
            myContractInstance.transfer.sendTransaction(pubkey, amount, {
              from: self.identity.pubkey,
              gasPrice: gasPrice,
              gas: 200000
            }, function(err, result) {
              if (err){
                if (cb) {
                  return cb(err);
                }
              }
              console.log(err, result);
              console.log('Tokens transfer started. TXhash=',result);
              cb(err,result);

            });
          });
        });
      },





    });
  </script>
</dom-module>
