<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../sc-web3/sc-web3.html">
<link rel="import" href="../sc-wallet/sc-wallet.html">
<link rel="import" href="../sc-vault/sc-vault.html">
<link rel="import" href="../sc-intro/sc-intro.html">
<link rel="import" href="../sc-home/sc-home.html">
<link rel="import" href="../sc-walletview/sc-walletview.html">
<link rel="import" href="../sc-profile/sc-profile.html">
<link rel="import" href="../sc-hashtag/sc-hashtag.html">
<link rel="import" href="../sc-newitem/sc-newitem.html">

<!-- <link rel="import" href="../sc-newdeal/sc-newdeal.html"> -->

<!--
`sc-boardwalk-app`


-->
<dom-module id="sc-boardwalk-app">
  <template>
    <style>
      :host {
        display: block;
        margin: 0px;
        padding: 0px;
        width: 100%;
        height: 100vh;
      }

      neon-animated-pages {
        height: 100%;
      }
      
      sc-vault {
        width: 100vw;
        height: 100vh;
      }
    
      sc-profile {
        width: 100vw;
        height: 100vh;
      }

      sc-hashtag {
        width: 100vw;
        height: 100vh;
      }
    </style>

   <!--  <app-location route="{{route}}" use-hash-as-path></app-location> -->
    <app-route route="[[route]]" pattern="/:page" data="{{routedata}}" tail="{{pageTail}}"></app-route>
   

 <!-- <app-route route="[[route]]" pattern="/:page" data="{{routedata}}" tail="{{pageTail}}"></app-route> -->
    <sc-web3 id="web3" web3="{{web3}}" keystore="[[keystore]]"></sc-web3>
    <sc-wallet
        id="wallet"
        web3="[[web3]]"
        pubkey="[[account]]"
        updating="{{balanceupdating}}"
        arcbalance="{{arcbalance}}"
        swtbalance="{{swtbalance}}"
        ethbalance="{{ethbalance}}"
        status="{{walletstatus}}"
        lowgas="{{lowgas}}"
        emptygas="{{emptygas}}"
        on-ready="checkready"
        >
    </sc-wallet>

  <neon-animated-pages attr-for-selected="data-page" selected="[[routedata.page]]">

   <!--  <sc-loadview
        data-page="loading"
        msg="">
    </sc-loadview> -->

    <sc-swtconversion
      data-page="swt"
      id="swt"
      route="[[pageTail]]"
      keystore="[[keystore]]"
      web3="[[web3]]"
      account="[[account]]"
      on-exit="logout"
      on-success="profile_tohome"
      on-converted="converted"
      >
    </sc-swtconversion>

    <sc-intro
      id="intro"
      data-page="intro"
      on-newvault="intro_createNewVault"
      on-importfile="intro_toimportfile"
      on-importethwallet="intro_toimportethwallet"
      on-importpk="intro_toimportpk"
      on-externalpk="intro_toexternalpk"
      on-vaultlocked="intro_toUnlockVault"
      on-enter="enter"
      on-exit="intro_toAppStart"
      on-restoreipfs="intro_torestoreipfs"
      route="[[pageTail]]"
      vaultstatus="[[vaultstatus]]"
      >
    </sc-intro>

    <sc-vault
      id="vault"
      data-page="vault"
      route="[[pageTail]]"
      currentkeystore="{{keystore}}"
      currentidentity="{{identity}}"
      currentaccount="{{account}}"
      lastbackup="{{lastbackup}}"
      on-ready="checkready"
      status="{{vaultstatus}}"
      on-backupexit="toProfile"
      on-exit="intro_toAppStart"
      >
    </sc-vault>

    <sc-home
      id="home"
      data-page=""
      keystore="[[keystore]]"
      identity="[[identity]]"
      lastbackup=[[lastbackup]]
      web3="[[web3]]"
      pubkey="[[account]]"
      swtbalance="[[swtbalance]]"
      ethbalance="[[ethbalance]]"
      balanceupdating="[[balanceupdating]]"
      on-to-profile="home_toprofile"
      on-to-walletview="home_towalletview"
      on-to-hashtag="home_tohashtag"
      >
    </sc-home>


    <sc-profile
      data-page="profile"
      id="profile"
      identity="[[identity]]"
      lastbackup=[[lastbackup]]
      pubkey="[[account]]"
      on-leave="profile_tohome"
      on-identity-update="saveIdentity"
      on-backup="toBackup"
      on-logout="logout"
      on-deletevault="deletevault"
      >

    </sc-profile>


    <sc-walletview
      data-page="walletview"
      id="walletview"
      web3="[[web3]]"
      keystore="[[keystore]]"
      identity="[[identity]]"
      account="[[account]]"
      lowgas="[[lowgas]]"
      emptygas="[[emptygas]]"
      on-leave="walletview_tohome"
      on-refreshneeded="refreshwallet"
      updating="[[balanceupdating]]"
      swtbalance="[[swtbalance]]">
    </sc-walletview>

    <sc-hashtag
      data-page="hashtag"
      id="hashtag"
      keystore="[[keystore]]"
      identity="[[identity]]"
      pubkey="[[account]]"
      on-leave="hashtag_tohome"
      on-to-itemdetail="toItemdetail"
      on-to-newitem="hashtag_to_newitem"
      currenthasht="{{currenthasht}}">
    </sc-hashtag>

    <sc-newitem
      data-page="newitem"
      identity="[[identity]]"
      pubkey="[[account]]"
      on-back="newitem_to_hashtag"
      on-leave="newitem_to_home"
      on-to-hashtag="newitem_to_hashtag"
      currenthasht="{{currenthasht}}">
    </sc-newitem>



 </neon-animated-pages>

  </template>

  <script>
    Polymer({

      is: 'sc-boardwalk-app',

      properties: {
        route: {
          type: Object
        },
        version: {
          type: String,
          value: '0.1'
        }
      },
      
      observers: [
        '_onRouteDataChanged(routedata.page)'
      ],

      ready: function(){
        //this.transitionto('/p1');
      },

      attached: function(){
        console.log('sc-boardwalk-app -> loaded');
        this.fire('loaded');
        this.checkready();
      },

      onEnter: function(){
        console.log('sc-boardwalk -> onEnter');  
      },

      onExit: function(){
        console.log('sc-boardwalk -> onExit');
      },

      exit: function() {
        this.fire('exit');
      },

      checkready: function(e) {

        console.log('checkready -> ',this.route);

        if (this.route && this.route.path !== ""){
          console.log('path specified...');
          return;
        }


        if (!this.vaultstatus) {
          return;
        }

        if (this.vaultstatus == 'locked') {
          // TODO this is a patch for when we uploaded a JSON file. Should be part of larger router...
          if (this.route.path != '/vault/importfile' ){
            return this.transitionto('/vault/unlock');
          }
        }

        if (this.vaultstatus == 'unlocked') {
          if (!this.walletstatus){
            return;
          }
          if (this.walletstatus == 'ready'){
            // no NOW we can check ARC/SWT balance
            if (this.arcbalance>0){
              console.log('having SRC balance -> to convert');
              return this.transitionto('/swt/intro');
            }else{
              console.log('no SRC balance -> head home');
              return this.transitionto('/home');
            }
          }
        }

        if (this.vaultstatus == 'novault') {
          return  this.transitionto('/intro/welcome');
        }

      },

      intro_toAppStart: function(){
        this.transitionto('/intro/welcome');
      },
      transitionto: function(target){
        console.log('sc-boardwalk-app -> transitionTo',target);
        this.set('route.path',target);
      },

      _onRouteDataChanged: function(page,oldpage) {
        if (!page){
          return;
        }
        console.log('sc-boardwalk-app -> _onRouteDataChanged',oldpage,'->',page);
       },

      // intro routing
      intro_createNewVault: function(){
        this.transitionto('/vault/createnew');
      },    

      intro_toimportfile: function(){
        this.transitionto('/vault/importfile');
      },   

      intro_toimportethwallet: function(){
        this.transitionto('/vault/importethwallet');
      },   

      intro_toimportpk: function(){
        this.transitionto('/vault/importpk');
      },

      intro_toexternalpk: function(){
        this.transitionto('/vault/externalpk');
      }, 

      intro_toUnlockVault: function(){
        //this.transitionto('/vault/unlock');
      },    

      intro_torestoreipfs: function(){
        this.transitionto('/vault/importipfs');
      },

      home_toprofile: function(){
        this.transitionto('/profile');
      },

      home_towalletview: function(){
        console.log("yes, home_towalletview");
        this.transitionto('/walletview');
      },

      home_tohashtag: function(e){
        // console.log("yes, home_tohashtag");
        this.currenthasht = e.detail;
        this.transitionto('/hashtag');
      },


      profile_tohome: function(){
        this.transitionto('/home');
      },

      walletview_tohome: function(){
        this.transitionto('/home');
      },


      hashtag_tohome: function(){
        this.transitionto('/home');
      },

      hashtag_to_newitem: function(){
        this.transitionto('/newitem');
      },


      newitem_to_home: function(){
        this.transitionto('/home');
      },

      newitem_to_hashtag: function(){
        this.transitionto('/hashtag');
      },


      saveIdentity: function(e) {
        this.identity = e.detail;
        this.$.vault.saveVault();
      },

      logout: function(){
        this.transitionto('/vault/unlock');
        this.fire('exit');
      },

      converted: function(){
        this.transitionto('/home');
      },



    });
  </script>
</dom-module>
