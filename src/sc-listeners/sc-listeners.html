<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../sc-redux/sc-redux.html">
<link rel="import" href="../sc-shh/sc-shh.html">
<link rel="import" href="../sc-web3/sc-web3.html">

<dom-module id="sc-listeners">
  <template>
    <sc-web3 id="web3" web3="{{web3}}"></sc-web3>
    <sc-shh web3="{{shhweb3}}"></sc-shh>  
  </template>
  <script>
    Polymer({
      is: 'sc-listeners',
      
      properties: {
        deals: {
          type: Array,
          statePath: 'deals',
        },
        mydeals: {
          type: Array,
          statePath: 'mydeals',
        },
        otherdeals: {
          type: Array,
          statePath: 'otherdeals',
        },   
      },

      behaviors: [
        ReduxBehaviour
      ],

       observers: [
        //'_starthastaglistener(shhweb3)',
      ],

      actions: {

        request_create: function(dealdata) {

          var foundDeal = this.deals.findIndex(function(item) {
            return item.id === dealdata.id;
          });

          let deals = this.deals.slice(0);

          if (foundDeal > -1) {
            deals[foundDeal] = Object.assign({}, deals[foundDeal],dealdata);
          } else {
            var newDeal = {
              id: dealdata.id,
              seeker: dealdata.seeker,
              msg: dealdata.offer,
              offercreationtx: dealdata.offercreationtx,
              amount: dealdata.offeramount,
              hashtag: dealdata.offerhashtag,
              offertime: dealdata.offertime
            };
            deals.push(newDeal);
          }
          
          if (dealdata.offercreationtx){
            this.getdealaddressfromtx(dealdata.id,dealdata.offercreationtx);
          }

          deals.sort(function(a, b) {
            return b.offertime - a.offertime;
          });

          return {
            type: 'DEALS',
            deals: deals
          };
        },

        request_seeker_funding: function(payload){
          var foundDeal = this.deals.findIndex(function(item) {
            return item.id === payload.id;
          });

          let deals = this.deals.slice(0);

          deals[foundDeal] = Object.assign({}, deals[foundDeal], {
            offerseekerfundingtx: payload.offerseekerfundingtx
          });

          this.updatebalanceaddressaftertx(payload.id,payload.offerseekerfundingtx);
          
          return {
            type: 'DEALS',
            deals: deals
          };

        },

        request_reply: function(replydata) {

          var foundDeal = this.deals.findIndex(function(item) {
            return item.id === replydata.parentrequestid;
          });

          let deals = this.deals.slice(0);
          //debugger;
          var reply = {
            id: replydata.id,
            msg: replydata.reply,
            provider: replydata.replyer,
            replytime: replydata.replytime,
            parentrequestid: replydata.parentrequestid
          };

          if (foundDeal > -1) {
            var deal = deals[foundDeal];
            if (deal.replies) {
              var foundDeal = deal.replies.findIndex(function(item) {
                return item.id === replydata.id;
              });
              deal.replies[foundDeal] = reply;
            } else {
              deal.replies = [reply];
            }
          } else {
            // this message comes before the deal info. Create an empty placehodler
            var newDeal = {
              id: replydata.parentrequestid,
              seeker: {
                pubkey: '0x0'
              },
              replies: [reply]
            };
            deals.push(newDeal);
            //console.error('no deal found for reply with ID=', replydata.id)
          }

          deals.sort(function(a, b) {
            return b.offertime - a.offertime;
          });
         
          return {
            type: 'DEALS',
            deals: deals
          };
        },

        request_setaddress: function(params) {

          var foundDeal = this.deals.findIndex(function(item) {
            return item.id === params.dealid;
          });

          let deals = this.deals.slice(0);

          deals[foundDeal] = Object.assign({}, deals[foundDeal], {
            dealaddress: params.address
          });
          return {
            type: 'DEALS',
            deals: deals
          };

        },


        request_seekerfunded: function(params) {

          var foundDeal = this.deals.findIndex(function(item) {
            return item.id === params.dealid;
          });

          let deals = this.deals.slice(0);

          deals[foundDeal] = Object.assign({}, deals[foundDeal], {
            dealbalance: params.balance
          });
          return {
            type: 'DEALS',
            deals: deals
          };

        },     

      },

      stopFiltering: function(options,cb){
        this.options
      },

      _starthastaglistener: function(hashtag) {
        
        var self = this;
        
        if (!self.shhweb3){
          return;
        }

        if (this.filter) {
          //console.log("sc-listeners: killing existing filter");
          //this.filter.stopWatching();
          return;
        }

       
        if (this.shhweb3 && hashtag) {

          var mytopics = [
            self.shhweb3.encodetopic("swarmcity-v1"),
            null,
            self.shhweb3.encodetopic(hashtag),
            null, // ID
            //[null,self.shhweb3.encodetopic(this.geohash.slice(0, 1))],
           // [null,self.shhweb3.encodetopic(this.geohash.slice(0, 2))],
           // null,
           // null
          ];

          this.filter = self.shhweb3.shh.filter({
            "topics": mytopics,
          });

          console.log("sc-listeners: channelswitch, start listening to", mytopics);
          this.filter.watch(this._processmessage.bind(this));
        }
      },

      // processinging of channel setup messages.
      _processmessage: function(error, result) {
        //debugger;
        var payload;
        var self = this;
        try {
          payload = JSON.parse(self.shhweb3.toAscii(result.payload));
          console.log('incoming in whisperer: shhweb3 ', payload);
          
          //this.push('deals',payload);
        } catch (e) {
          console.log(e);
        }

        switch(payload.type){
          case 'dealfortwo-request-create':
            this.dispatch('request_create', payload);
            this.requestsloaded = true;
            break;
          case 'dealfortwo-seeker-funding':
            this.dispatch('request_seeker_funding', payload);
            break;
          case 'dealfortwo-request-reply':
            this.dispatch('request_reply', payload);
          case 'engage-in-deal':
          case 'reply-to-deal':
          case 'seeker-acceptdeal':
            break;
          default:
          //debugger;
            console.log('unknown message:',payload);
            break;
        }

      },


      ready: function(){
      
      },


      getdealaddressfromtx: function(dealid,tx){
        //debugger;
        console.log('Start monitoring for address from deal tx',tx);
        if (!tx){
          return;
        }
        var self = this;
        this.helper_getDealAddressFromTx(tx,function(err,address,blocknumber){
          console.log('the address of deal',dealid,'is',address);
          self.dispatch('request_setaddress',{dealid:dealid,address:address});
          self.helper_watchbalance(address,blocknumber);
        });
      },


      updatebalanceaddressaftertx: function(dealid,tx){
        var self = this;
        console.log('Start monitoring for balance from deal tx',tx);
        if (!tx){
          return;
        }

        this.web3.waitTx(tx, function(err, res) {
          // update balence
          self.dispatch('request_seekerfunded', {
            dealid: dealid,
            balance: 12345
          });

        });

      },


      helper_watchbalance(address,startblock){
        // var self = this;
        // self.contracturl = self.resolveUrl('../contracts/MiniMeToken.json');
        // self.importHref(self.contracturl, function(e) {
        //   var contractjson = JSON.parse(e.target.import.body.innerText);
        //   var SWTTokenContract = self.web3.eth.contract(contractjson.abi);
        //   var SWTTokenContractInstance = SWTTokenContract.at(self.config.swttokencontractaddress);

        //   var myEvent = SWTTokenContractInstance.Transfer(null, {
        //         fromBlock: startblock,
        //       });
        //       myEvent.get(function(error, result) {
        //         var myEvent = result.find(function(item) {
        //           return item.transactionHash === tx;
        //         });
        //         if (!myEvent || !myEvent.args || !myEvent.args.simpleDealAddress){
        //           return cb('event not found');
        //         }
        //         var address = myEvent.args.simpleDealAddress;
        //         return cb(null, address,res.blockNumber);
        //       });



        //   SWTTokenContractInstance.balanceOf(address, function(err, swtbalance) {
        //     return cb(null, swtbalance);
        //   });
        // });
      },


      helper_getDealAddressFromTx(tx, cb) {
        var self = this;
        this.web3.waitTx(tx, function(err,res) {
          if (err){
            return cb(err);
          }
          if (res.blockNumber) {
            self.contracturl = self.resolveUrl('../contracts/DealForTwoFactory.json');
            self.importHref(self.contracturl, function(e) {
              var contractjson = JSON.parse(e.target.import.body.innerText);
              var DealForTwoFactoryContract = self.web3.eth.contract(contractjson.abi);
              var DealForTwoFactoryContractInstance = DealForTwoFactoryContract.at(self.config.dealfortwofactory);
              var myEvent = DealForTwoFactoryContractInstance.NewSimpleDeal(null, {
                fromBlock: res.blockNumber,
                toBlock: res.blockNumber
              });
              myEvent.get(function(error, result) {
                var myEvent = result.find(function(item) {
                  return item.transactionHash === tx;
                });
                if (!myEvent || !myEvent.args || !myEvent.args.simpleDealAddress){
                  return cb('event not found');
                }
                var address = myEvent.args.simpleDealAddress;
                return cb(null, address,res.blockNumber);
              });
            });
          } else {
            return cb('not yet mined');
          }
        });
      },




    });
  </script>
</dom-module>
