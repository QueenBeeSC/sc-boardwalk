<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<script src="../../node_modules/redux/dist/redux.min.js"></script>
<link rel="import" href="../../bower_components/polymer-redux/polymer-redux.html">

<link rel="import" href="../../bower_components/sc-style/sc-style.html">
<link rel="import" href="../../bower_components/sc-iconset/sc-iconset.html">

<link rel="import" href="../sc-avatar/sc-avatar.html">
<link rel="import" href="../sc-username/sc-username.html">
<link rel="import" href="../sc-balance/sc-balance.html">
<link rel="import" href="../sc-hashtagitem/sc-hashtagitem.html">
<link rel="import" href="../sc-newitem/sc-newitem.html">
<link rel="import" href="../sc-shh/sc-shh.html">
<link rel="import" href="../sc-itemdetail/sc-itemdetail.html">


<!--
`sc-hashtag`

This is the component showing all requests of a certain hashtag. It contains a repeater of sc-hashtagitem fot that and a sc-filter for filtering this list of requests.

@demo src/sc-hashtag/demo/index.html 
-->

<dom-module id="sc-hashtag">
<link rel="import" href="../../bower_components/sc-style/sc-style.css" type="css">
  <template>
    <style>
      :host {
        display: block;
        @apply(--base-structure);
        width: 100%;
        height: 100%;
      }

      neon-animated-pages {
        height: 100%;
        width: 100%;
      }

      .avatar_username_balance_hashtagcontent {
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-start-justified); 
        box-sizing:border-box;
        padding: 0px 14vw 0px 14vw;   
        height: 100%;
      }

      .avatar_username_balance {
        height: 100%;
        box-sizing:border-box;
        padding: 18vh 0px 18vh 0px;
        margin-right: 5vw;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-start-justified);
      }

      #hashtagcontent {
        box-sizing:border-box;
        padding-top: 18vh;
        overflow-y:scroll;
        height: 100%;
      }

      sc-balance {
        margin-top: 26px;
        /*border:1px solid red;*/
      }

      .paddingsides {
        padding-left: 4vw;
        padding-right: 4vw;
      }


      .hashtagtitle p {
        font-size: 30px;
        line-height: 30px;
        margin: 0px 0px 2px 0px;
      }

      .symbol p {
        font-size: 27px;
        line-height: 27px;  
        margin: 0px 6px 0px 0px;

      }

      .symbol {
        margin-top: 6px;
      }


      .margright {
        margin:0px 6px 0px 0px;
      }

      .wordbreak {
        word-break: keep-all;
      }

      sc-avatar {
        margin: 0px 0px 20px 0px;
      }
      .backhash {
        margin:6px 0px 0px 8px;    
      }


      sc-hashtagitem {
        width: 100%;
        max-width: 600px;
        margin: 2vh 0px;
      }
      paper-icon-button.addbtn {
        position: fixed;
        top: 80vh;
        right: 9vw;
        font-size: 45px;
        padding: 3px;
        z-index: 99;
        box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        -webkit-box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        -moz-box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        -o-box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        width: 75px;
        height: 75px;
        box-sizing:border-box;
        color: var(--sc-blue);
      }


      .profilebalance_box {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        min-width: 180px;
      }

      .default {
        display: block;
      }

      .mobile {
        display: none;
      }

    @media all and (min-width: 0) and (max-width: 420px) { 

      .avatar_username_balance_hashtagcontent {
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        box-sizing:border-box;
        padding: 0px;            
      }

      .avatar_username_balance {
        width: 100%;
        height: 14%;
        min-height: 82px;
        box-sizing:border-box;
        padding: 30px 30px 0px 50px;
        margin-right: 0px;
        @apply(--layout-horizontal-reverse);
        @apply(--layout-center);
        @apply(--layout-start-justified);
      }

      sc-balance {
        margin-top: 0px;
        /*border:1px solid red;*/
      }

      .hashtagtotal {
        @apply(--layout-horizontal);
        @apply(--layout-end);
        @apply(--layout-start-justified);
        box-sizing:border-box;
        padding: 5px 15px 0px 15px;
      }

      .hashtagtitle {
        margin: 0px 0px 10px 0px;
      }

      .hashtagtitle p {
        font-size: 20px;
        line-height: 24px;
        color: var(--sc-grey4);
      }

      .symbol p {
        font-size: 19px;
        line-height: 28px;
        margin: 0px 0px 0px 0px;
      }

      .symbol {
        margin: 0px 3px 0px 6px;
      }

      .decliner {
        margin:0px 0px 0px 8px;
      }

      .decliner iron-icon {
        width: 32px;
        height: 36px;
      }


      .avatar-box {
        box-sizing:border-box;
        padding: 0px 0px 0px 15px;
      }


      paper-icon-button.addbtn {
        position: fixed;
        top: 80vh;
        right: 9vw;
        font-size: 45px;
        padding: 3px;
        z-index: 99;
        box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        -webkit-box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        -moz-box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        -o-box-shadow: 0px 1px 15px -1px rgba(0,0,0,0.1), 0px 1px 3px -1px rgba(0,0,0,0.75);
        width: 75px;
        height: 75px;
        box-sizing:border-box;
        color: var(--sc-blue);
      }

      .addspace {
        box-sizing:border-box;
        padding: 18px;
        border-radius: 5px;
        margin: 20px 0px 20px 0px; 
      }


      .addspace p {
        font-size: 22px;
        margin: 0px 0px 6px 14px;
      }


      #hashtagcontent {
        box-sizing:border-box;
        padding-top: 0px;
      }

      sc-avatar {
        margin: 0px 0px 0px 20px;
      }

      .profilebalance_box {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        @apply(--layout-center);
        min-width: 180px;
      }

      .backhash {
        margin: 2px 0px 0px 5px;
      }
    }

    </style>
 
    <sc-shh web3="{{web3}}"></sc-shh>

    
    <iron-media-query query="(min-width:0px) and (max-width: 420px)" query-matches="{{phoneview}}"></iron-media-query>

    <app-route route="{{route}}" pattern="/:hashtag/:action" data="{{data}}"></app-route>



    <div class="avatar_username_balance_hashtagcontent totalwidth">
        <div class="avatar_username_balance" on-tap="toProfile">
          <sc-avatar
          ipfshash="[[identity.avatarhash]]"
          pubkey="[[pubkey]]"
          id="hashtagavatar"
          size="{{currentviewmode}}"
          ></sc-avatar>
          <sc-username
          class$="{{visibleclass}}"
          id="hashtagusername"
          identity="[[identity]]"
          pubkey="[[pubkey]]"
          size="small"
          ></sc-username>
          <div id="balancebox" class="profilebalance_box" on-tap="toWalletview">
            <sc-balance
              refcur="EUR"
              swtbalance="[[swtbalance]]"
              ethbalance="{{ethbalance}}"
              viewmode="{{currentviewmode}}"
              ></sc-balance>
          </div>
        </div>


    <neon-animated-pages id="hashpages" attr-for-selected="data-action" selected="[[data.action]]">

      <neon-animatable data-action="list">
        <paper-icon-button id="addbtn" icon="sc-icons:plus" class="left whiteback shadow medium addbtn" on-tap="tonewItem" noink>+ new offer</paper-icon-button>

          <div id="hashtagcontent" class="totalwidth paddingsides">
            <div id="{{item}}" class="hashtagtotal totalwidth horizont centercenter">
              <div class="hashtagtitle horizont start startjust">
                <div class="symbol">
                  <p class="semibold">#</p>
                </div>
                <p class="bold wordbreak">pioneer</p>
                <iron-icon on-tap="leave" icon="sc-icons:decline" class="small backhash grey4">back</iron-icon>
              </div>
              <div class="flex"></div>
            </div>
            <template is="dom-repeat" items="{{deals}}">
<!--               <sc-hashtagitem
                item="[[item]]"
                offereravatar="{{item.offereravatar}}"
                offerer="{{item.offerer}}"
                offererrep="{{item.offererrep}}"
                offer="{{item.offer}}"
                offerhashtag="{{item.offerhashtag}}"
                offertime="{{item.offertime}}"
                offeramount="{{item.offeramount}}"
                nrofreplies="{{item.nrofreplies}}"
                on-tap="hashtag_to_detail">
              </sc-hashtagitem> -->


              <sc-hashtagitem
                item="[[item]]"
                on-to-detail="hashtag_to_detail">
              </sc-hashtagitem>
            </template>
          </div>
      </neon-animatable>

      <sc-newitem
        data-action="newitem"
        identity="[[identity]]"
        pubkey="[[account]]"
        on-back="newitem_cancel"
        on-cancel=""
        on-new-submitted="newitem_submitted"
        >
      </sc-newitem>

      <sc-itemdetail
      data-action="detail"
      itemdata="[[currentitem]]"
      on-back="detail_to_list"
      on-reply-selected="detail_to_reply"
      ></sc-itemdetail>


      <sc-itemreply
      data-action="replydetail"
      itemdata="[[currentitem]]"
      replydata="[[currentreply]]"
      on-back="reply_to_detail"
      ></sc-itemdetail>


    </neon-animated-pages>
        </div>

  </template>

  <script>
    const reducer = (state, action) => {
      if (!state) return {
        deals: []
      };
      // copy deals list
      deals = state.deals.slice(0);
      switch (action.type) {
        case 'ADD_ITEM':
          deals.push(action.deal);
          break;
        case 'REMOVE_ITEM':
          const idx = deals.indexOf(action.deal)
          if (idx !== -1) {
            deals.splice(idx, 1)
          }
          break;
      }
      state.deals = deals;
      return state;
    }
    const store = Redux.createStore(reducer);
    const ReduxBehavior = PolymerRedux(store);

    Polymer({
      is: 'sc-hashtag',

      // behaviors: [
      //   Polymer.NeonSharedElementAnimatableBehavior
      // ],
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        ReduxBehavior
      ],

      actions: {

        add: function(dealdata) {
          return {
            type: 'ADD_ITEM',
            deal: dealdata
          };
        },
        remove: function(dealdata) {
          return {
            type: 'REMOVE_ITEM',
            deal: dealdata
          };
        }
      },

      observers: [
      '_web3(web3)'
    ],
      properties: {

        route: {
          type: Object,
          notify: true
        },
        deals: {
          type: Array,
          statePath: 'deals'
        },
        /**
       * `phoneview` is a boolean to determine the viewport.
       */ 
        phoneview: {
          type: Boolean,
          observer: '_checkSize'
        },

        /**
       * `sharedElements` is used to share elements between components for doing animations.
       */ 
        sharedElements: {
          type: Object,
          value: function() {
            return {
              'hero': this.$.hashtagavatar,
              'balance': this.$.balancebox
            }
          }
        },

        /**
       * `animationConfig` is used to configure animations.
       */
        animationConfig: {
          type: Object,
          value: function() {
            return {
              'entry': [{
                name: 'slide-from-bottom-animation',
                node:this.$.hashtagcontent,
                toPage: this,
                timing: {
                  duration: 700
                }
              }, {
                name: 'hero-animation',
                id: 'hero',
                toPage: this,
                timing: {
                    duration: 600
                }
              }, {
                name: 'hero-animation',
                id: 'balance',
                toPage: this,
                timing: {
                    duration: 600
                }
              }],

              'exit': [{
                name: 'slide-down-animation',
                node:this.$.hashtagcontent,
                fromPage: this,
                timing: {
                  duration: 700
                }

              // },{
              //   name: 'fade-out-animation',
              //   node:this.$.backbtn,
              //   fromPage: this,
              //   timing: {
              //     duration: 125
              //   }

              }, {
                name: 'hero-animation',
                id: 'hero',
                fromPage: this,
                timing: {
                    duration: 600
                }
              }, {
                name: 'hero-animation',
                id: 'balance',
                fromPage: this,
                timing: {
                    duration: 600
                }
                }]
              }
            },
          },

        },


      ready: function() {
          this._checkSize();
        

          this.dispatch('add', {
              offereravatar: 'QmWA8eaJyZpVT5mUx1qBvbNXYfprSdds1oachxmhV1sDGh',
              offerer: 'Mr Rogers',
              offer: 'This is just a test-request!',
              offerhashtag: 'pioneer',
              offererrep: '6',
              offertime: 'a few minutes ago',
              offeramount: '233.50',
              // nrofreplies: '2'
              replies: [
                {
                  replyer: {
                    replyeravatar:'QmWA8eaJyZpVT5mUx1qBvbNXYfprSdds1oachxmhV1sDGh',
                    replyerusername:'Mr Rogers',
                    replyerrep: '0'},
                  reply: 'Ik reageer op men eigen item!',
                  replyamount: '44',
                  replytime:'Just now'
                },
                {
                  replyer: {
                    replyeravatar:'QmWA8eaJyZpVT5mUx1qBvbNXYfprSdds1oachxmhV1sDGh',
                    replyerusername:'Mr Rogers',
                    replyerrep: '0'},
                  reply: 'Ik reageer op men eigen item!',
                  replyamount: '44',
                  replytime:'Just now'
                }
              ]

            });


          // this.deals = [
          //  {
          //     offereravatar: 'QmWA8eaJyZpVT5mUx1qBvbNXYfprSdds1oachxmhV1sDGh',
          //     offerer: 'Mr Rogers',
          //     offer: 'This is just a test-request!',
          //     offerhashtag: 'pioneer',
          //     offererrep: '6',
          //     offertime: 'a few minutes ago',
          //     offeramount: '233.50',
          //     nrofreplies: '2'
          //   },
           // {
           //    offereravatar: 'http://jcket.com/stoneyroads/files/2014/10/600x/Mr-Oizo.jpg',
           //    offerer: 'Mr Oizo',
           //    offer: 'Need a ride from 5905 hidden valley trl to 2408 wolf run',
           //    offerhashtag: '#ridesharing',
           //    offererrep: '22',
           //    offertime: 'today at 21:25',
           //    offeramount: '330.00',
           //    nrofreplies: '0'
           //  },
           // {
           //    offereravatar: 'http://vignette3.wikia.nocookie.net/southpark/images/c/c2/Butters_(Facebook).jpg/revision/latest?cb=20101010032409',
           //    offerer: 'Leopold Butters',
           //    offer: 'I need a pick up from 2795 pleasant vally',
           //    offerhashtag: '#ridesharing',
           //    offererrep: '398',
           //    offertime: 'yesterday at 19:45',
           //    offeramount: '330.00',
           //    nrofreplies: '4'
           //  },          
           // {
           //    offereravatar: 'http://jcket.com/stoneyroads/files/2014/10/600x/Mr-Oizo.jpg',
           //    offerer: 'Mr Oizo',
           //    offer: 'Need a ride pick up at walmart on ben white and dropped off at 5711 meadow crest',
           //    offerhashtag: '#ridesharing',
           //    offererrep: '22',
           //    offertime: '2 days ago',
           //    offeramount: '330.00',
           //    nrofreplies: '0'
           //  },
          // ];



      },


 _web3: function() {
    var self = this;
  

    if (!this.web3){
      throw new Error('web3 not set while requesting whisper listener');
    }

    if (self.web3) {

      //this._stopTopicFilter();

      var topic = "pioneer";
      this.filter = self.web3.shh.filter({
        "topics": [self.web3.fromAscii(topic)],
      });

      console.log("sc-whisperer: channelswitch, start listening to", topic, ' knows web3 ', this.web3);
      this.filter.watch(this._processmessage.bind(this));
    }
  },

  // processinging of channel setup messages.
  _processmessage: function(error, result) {
      console.log('incoming in whisperer: web3 ', this.web3);
      var self = this;
      var payload = JSON.parse(self.web3.toAscii(result.payload));
      this.dispatch('add',payload);
        // this.dispatch('add', {
        //       offereravatar: 'QmWA8eaJyZpVT5mUx1qBvbNXYfprSdds1oachxmhV1sDGh',
        //       offerer: 'Mr Rogers',
        //       offer: 'This is just a test-request!',
        //       offerhashtag: 'pioneer',
        //       offererrep: '6',
        //       offertime: 'a few minutes ago',
        //       offeramount: '233.50',
        //       nrofreplies: '2'
        //     });      
    },


      /**
      * 'onEnter' are the behaviors that occur when the router tells this component enters the stage 
      * use this to initialize any variables to start the component
      */
      onEnter: function(){
      },

      /**
      * 'onExit' are the behaviors that occur when the router tells this component to leave the stage 
      * use this to reset any variables when leaving this component while it remains loaded.
      */
      onExit: function(){
      },

      /**
      * '_checkSize' responds to the iron-media-query and sets some variables according to the result.
      */      
      _checkSize: function() {
        if (this.phoneview) {
        this.visibleclass = 'mobile';
        this.currentviewmode = "small";
        } else {
        this.visibleclass = 'default';
        this.currentviewmode = "normal";
        }
      },

      /**
      * 'leave' fires the 'leave' to the parent-element. (This also contains animation-config for going back to sc-home.)
      */
      leave: function(){
        this.fire('leave');
      },

      /**
      * 'tonewItem' .
      */
      tonewItem: function(){
          this.sharedElements = {
              'hero': this.$.hashtagavatar,
              'balance': this.$.balancebox
            };

            this.animationConfig = {

              'entry': [{
                name: 'slide-from-bottom-animation',
                node:this.$.hashtagcontent,
                toPage: this,
                timing: {
                  duration: 700
                }
              }, {
                name: 'hero-animation',
                id: 'hero',
                toPage: this,
                timing: {
                    duration: 600
                }
              }, {
                name: 'hero-animation',
                id: 'balance',
                toPage: this,
                timing: {
                    duration: 600
                }
              }],


              'exit': [{
                name: 'slide-down-animation',
                node:this.$.hashtagcontent,
                fromPage: this,
                timing: {
                  duration: 700
                }

              },{
              //   name: 'fade-out-animation',
              //   node:this.$.backbtn,
              //   fromPage: this,
              //   timing: {
              //     duration: 125
              //   }

              // }, {
                name: 'hero-animation',
                id: 'hero',
                fromPage: this,
                timing: {
                    duration: 600
                }
              }, {
                name: 'hero-animation',
                id: 'balance',
                fromPage: this,
                timing: {
                    duration: 600
                }
                }]
              };

        this.set('route.path','/pioneer/newitem');
      },

      /**
      * 'hashtag_to_detail' fires 'to-itemdetail' to the parent-element, and includes the animationconfig for this action.
      */
      hashtag_to_detail: function(e){
        console.log("Dit is de e uit hashtgitem",e.detail);
        this.currentitem = e.detail;
        this.set('route.path','/pioneer/detail');
      },

      detail_to_list: function(){
        this.set('route.path','/pioneer/list');
      },

      reply_to_reply_to_detail: function(){
        this.set('route.path','/pioneer/list');

      },


      newitem_cancel: function(e){
        this.set('route.path','/pioneer/list');
      },

      newitem_submitted: function(e){
        this.set('route.path','/pioneer/list');

        var newrequest = {
          offereravatar: this.identity.avatarhash,
          offerer: this.identity.username,
          offer: e.detail.msg,
          offerhashtag: 'pioneer',
          offererrep: '0',
          offertime: 'a few minutes ago',
          offeramount: e.detail.amount,
          nrofreplies: '0'
        }
        if (!this.shhidentity){
          this.shhidentity = this.web3.shh.newIdentity();
        }

        var options = {
          "from": this.shhidentity,
          "topics": [this.web3.fromAscii("pioneer")],
          "payload": this.web3.fromAscii(JSON.stringify(newrequest)),
          "ttl": 100,
          "priority": 1000
        };

        return this.web3.shh.post(options, function(err, res) {
          console.log(err, res);
        });


        // console.log('Yes!', newrequest);
        //this.dispatch('add',newrequest);
//        this.push('deals',newrequest);

      },

      // setAnimconfig: function(){
      //   var avatar = document.getElementById('hashtagavatar');
      //   var balance = document.getElementById('balancebox');
      //   // console.log("LOOOOOGGGG",avatar,balance);
      //   this.sharedElements = {
      //         'hero': avatar,
      //         'balance': balance
      //       };


      //     // this.sharedElements = {
      //     //     'hero': this.$.homeavatar,
      //     //     'balance': this.$.homebalance
      //     //   };

      //     this.animationConfig = {

      //         'entry': [{
      //           name: 'slide-from-top-animation',
      //           node:this.$.hashtagcontent,
      //           toPage: this,
      //           timing: {
      //             duration: 2700
      //           }
      //         }, {
      //           name: 'hero-animation',
      //           id: 'hero',
      //           toPage: this,
      //           timing: {
      //               duration: 600
      //           }
      //         }, {
      //           name: 'hero-animation',
      //           id: 'balance',
      //           toPage: this,
      //           timing: {
      //               duration: 600
      //           }
      //         }],


      //         'exit': [{
      //           // name: 'slide-down-animation',
      //           // node:this.$.hashtagcontent,
      //           // fromPage: this,
      //           // timing: {
      //           //   duration: 700
      //           // }

      //         // },{
      //         //   name: 'fade-out-animation',
      //         //   node:this.$.backbtn,
      //         //   fromPage: this,
      //         //   timing: {
      //         //     duration: 125
      //         //   }

      //         // }, {
      //           name: 'hero-animation',
      //           id: 'hero',
      //           fromPage: this,
      //           timing: {
      //               duration: 600
      //           }
      //         }, {
      //           name: 'hero-animation',
      //           id: 'balance',
      //           fromPage: this,
      //           timing: {
      //               duration: 600
      //           }
      //           }]
      //         };


      //   console.log("LOOOOOGGGG 2",this.sharedElements,this.animationConfig);

      // }


    });
  </script>
</dom-module>
