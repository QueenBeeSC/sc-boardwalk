<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../sc-web3/sc-web3.html">
<link rel="import" href="../sc-config/sc-config.html">
<link rel="import" href="../sc-helpers/sc-helpers.html">

<!--
`sc-backbone`

This is the component that links the blockchain published config to the app.
Example:
    <sc-backbone></sc-backbone>

-->

<dom-module id="sc-backbone">
  <template>
    <sc-web3 web3="{{web3}}"></sc-web3>  
    <sc-config config="{{config}}"></sc-config>
    <sc-helpers id="helpers"></sc-helpers>
  </template>
  <script>
    Polymer({

      is: 'sc-backbone',

      observers: [
        '_web3(web3)',
        '_configchanged(config)'
      ],    

      ready: function(){
        this.LLQueue = [];
      },

      _web3: function(){
        console.log('Web3 is here...');
        this.processLLQueue();
      },

      _configchanged: function(){
        console.log('config loaded - now I will be reading the contract...',this.config.backbonecontractaddress);
        var self=this;
        this.loadbackbonecontract(function(){
          self.ParametersInstance.getParameter.call('dapp.root',function(a,b){
            //console.log('resturned',a,b);
            self.processLLQueue();
          });  
        });
        
      },

      loadbackbonecontract: function(cb){
        var self=this;
        if (!this.web3 || !this.config){
          return;
        }
        this.$.helpers.getjson('../contracts/Parameters.json', function(err, contractjson) {
          var MyContract = self.web3.eth.contract(contractjson.abi);
          self.ParametersInstance = MyContract.at(self.config.backbonecontractaddress);
          cb();
        });      
      },

      lazyload: function(name){
        this.push('LLQueue',name);
      },

      processLLQueue: function(){
        if (this.web3 && this.config && this.LLQueue){
          console.log('processing Lazy loading...');
        }
      }


    });
  </script>
</dom-module>
