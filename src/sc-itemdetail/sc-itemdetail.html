<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/moment-js/moment-js.html">

<link rel="import" href="../../bower_components/sc-style/sc-style.html">
<link rel="import" href="../../bower_components/sc-iconset/sc-iconset.html">
<link rel="import" href="../sc-avatar/sc-avatar.html">
<link rel="import" href="../sc-itemreplier/sc-itemreplier.html">
<link rel="import" href="../sc-itemreply/sc-itemreply.html">
<link rel="import" href="../sc-shh/sc-shh.html">
<link rel="import" href="../sc-hashtagcontract/sc-hashtagrep.html">
<link rel="import" href="../sc-dealfeedback/sc-dealfeedback.html">
<link rel="import" href="../sc-dealstate/sc-dealstate.html">


<!--
`sc-itemdetail`

This components shows the detailed view of a request. 

@demo src/sc-itemdetail/demo/index.html 
-->

<dom-module id="sc-itemdetail">
  <template>
    <style include="sc-styles">
    :host {
      display: block;
      width: 100%;
      @apply(--base-structure);
    }

    .scrollcontainer {
      width: 100%;
      height: 100%;
    }

    .totalcontainer {
      width: 100%;
      @apply(--layout-vertical);
      @apply(--layout-start);
      @apply(--layout-start-justified); 
      box-sizing:border-box;
      padding-top: 18vh;
      height: 100vh;
      overflow-y:scroll;
    }

    .bordergreen {
      border: 2px solid green;
    }



    #itemdetailcontent {
      width: 100%;
      max-width: 700px;
    }

    .backbtnarea {
      padding: 25px 25px 0px 25px;
    }

    .detailpadding {
      box-sizing:border-box;
      padding-left: 40px;
      padding-right: 40px;
      padding-bottom: 30px;
    }


    .offereravatar {
      margin-right: 14px;     
    }


    .offer {
      font-size: 16px;
      line-height: 22px;
    }


    .amount {
      font-size: 36px;
    }

    .swt {
      font-size: 18px;
    }

    .offerhashtag {
      margin-left: 5px;

    }

    .backicon:hover {
      cursor: pointer;
    }

    .offertxt p {
      line-height: 20px;
    }

    .feedbackbox {
      border-top: 1px dotted var(--sc-grey2);
      box-sizing:border-box;
      padding-left: 40px;
      padding-right: 40px;
    }

    .halfop {
      opacity: 0.5;
    }

    .fullop {
      opacity: 1;
    }


    @media all and (min-width: 0) and (max-width: 540px) { 


        .totalcontainer {
          width: 100%;
          @apply(--layout-vertical);
          @apply(--layout-center-center);        
          box-sizing:border-box;
          padding-top: 4vh; 
          height: 86vh;
        }


        .scrollcontainer {
          width: 100%;
          height: 100%;
          @apply(--layout-vertical);
          @apply(--layout-center);   
          @apply(--layout-start-justified);   
        }


        #itemdetailcontent {
          width: 92%;
        }

        .backbtnarea {
          height: 49px;
        }

        .detailpadding {
          box-sizing:border-box;
          padding-left: 35px;
          padding-right: 35px;
          padding-bottom: 30px;
        }

        .feedbackbox {
          box-sizing:border-box;
          padding-left: 35px;
          padding-right: 35px;
        }

    }


    </style>
    <sc-shh web3="{{shhweb3}}"></sc-shh>
    <sc-dealstate deal="{{itemdata}}" dealstate="{{dealstate}}"></sc-dealstate>
    <iron-media-query query="(min-width:0px) and (max-width: 540px)" query-matches="{{phoneview}}"></iron-media-query>

    <div class="totalcontainer">
      <div class="scrollcontainer">
      <div id="itemdetailcontent" class="shadow whiteback totalwidth vertic">
        <div class="totalwidth horizont centercenter backbtnarea">
          <span class="flex"></span>
          <iron-icon class="grey3 backicon" icon="sc-icons:decline" on-tap="back">back</iron-icon>
        </div>
        <div class="totalwidth detailpadding">
          <div class$="totalwidth {{totalopacity}}">
            <p class="small grey3"><moment-js date="{{item.offertime}}" format="HH:mm:ss.SSS" from-now></moment-js></p>
            <div class="minispace"></div>
            <p class="offer light grey4">{{itemdata.msg}}<span class="bold offerhashtag">#{{itemdata.hashtag}}</span></p>
          </div>
          <div class="whitespace"></div>

          <template is="dom-if" if="{{phoneview}}">
            <div class$="totalwidth horizont centercenter {{totalopacity}}">
              <sc-avatar
                class="offereravatar"
                ipfshash="[[itemdata.seeker.avatarhash]]"
                size="medium">
              </sc-avatar>
              <div class="vertic start startjust offertxt flex">
                <p class="bold grey3">{{itemdata.seeker.username}}</p>
                <p class="bold rep blue"><sc-hashtagrep pubkey="{{itemdata.seeker.pubkey}}" hashtagname="{{itemdata.hashtag}}"></sc-hashtagrep> REP</p>
              </div>  
            </div>
            <div class="whitespace"></div>
            <div class$="totalwidth horizont centercenter {{amountopacity}}">
              <div class="flex"></div>
              <p class="bold yellow amount">{{itemdata.amount}} <span class="swt">SWT</span></p>
            </div>
          </template>


          <template is="dom-if" if="{{!phoneview}}">
          <div class="totalwidth horizont end centerjust">
            <div class$="totalwidth horizont centercenter flex {{totalopacity}}">
              <sc-avatar
                class="offereravatar"
                ipfshash="[[itemdata.seeker.avatarhash]]"
                size="medium">
              </sc-avatar>
              <div class="vertic start startjust offertxt flex">
                <p class="bold grey3">{{itemdata.seeker.username}}</p>
                <p class="bold rep blue"><sc-hashtagrep pubkey="{{itemdata.seeker.pubkey}}" hashtagname="{{itemdata.hashtag}}"></sc-hashtagrep> REP</p>
              </div>  
            </div>
              <p class$="bold yellow amount {{amountopacity}}">{{itemdata.amount}} <span class="swt">SWT</span></p>
          </div>
          </template>
        </div>
<!--           <div class="feedbackbox totalwidth">
            <sc-dealfeedback showsteps="create" dealstate="{{dealstate}}"></sc-dealfeedback>
          </div>

 -->
        <template is="dom-if" if="{{!youareowner(itemdata.seeker.pubkey)}}">
          <!-- <p>replypossible={{replypossible}}</p> -->
          <template is="dom-if" if="{{!itemdata.ireplied}}">
            <sc-itemreplier itemdata="{{itemdata}}">
            </sc-itemreplier>
          </template>
        </template>
        <div class="whiteback totalwidth">
        <template is="dom-repeat" items="{{itemdata.replies}}">
          <sc-itemreply
          itemdata="{{itemdata}}"
          btnshow="{{youareowner(itemdata.seeker.pubkey)}}"
          replydata="{{item}}"
          on-to-detail="fireReplyselected"
          on-item-detail="firetoItemdetail"
          on-to-makedeal="toMakeDeal">
          </sc-itemreply>
        </template>
        </div>
      </div>
      <div class="fivespace"></div>
      </div>
      </div>
  </template>

  <script>
    Polymer({

      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        ReduxBehaviour
      ],

      is: 'sc-itemdetail',

      observers: [
      '_dealstate(dealstate)'
        //'_web3(shhweb3)',
        //'_pubkeyCompare(itemdata)'
      ],

      properties: {
        /**
         * `itemdata` this is the first property and what it does is described right here.
         */
        itemid: {
          type: String,
          observer: '_getitemdata'
        },

        deals: {
          type: Array,
          statePath: 'deals',
          observer: '_getitemdata'
        },

        // youareowner: {
        //   type: Boolean,
        //   value: false
        // },

        /**
       * `identity` is received from parent-element, as an object containing an IPFS-hash, which is img-source.
       */
        identity: {
          type: Object,
          statePath: 'identity'
        },

        animationConfig: {
          type: Object,
          value: function() {
            return {
              'entry': [{
                name: 'slide-from-right-animation',
                node: this.$.itemdetailcontent,
                toPage: this,
                timing: {
                  duration: 600
                }

              }],

              'exit': [{
                name: 'fade-out-animation',
                node: this.$.itemdetailcontent,
                fromPage: this,
                timing: {
                  duration: 125
                }
              }]
            }
          },
        }


      },


      _web3: function() {
       // this.startListener();
      },

      youareowner: function(pubkey){
        //debugger;
        return (this.identity.pubkey == pubkey);
      },

      _getitemdata: function() {

        if (!this.itemid || !this.deals){
          return;
        }
        console.log(this.itemid);
        
        var self = this;
        //debugger;
        var foundDeal = this.deals.find(function(item){
            return item.id === self.itemid;
        });

        if (!foundDeal){
          return;
        }

        this.set('itemdata',foundDeal);


        // check if I have already replied to this deal.
        if (this.itemdata.replies){
          this.set('itemdata.replies',foundDeal.replies);
          // var foundReply = this.itemdata.replies.findIndex(function(item){
          //   return item.provider.pubkey === self.identity.pubkey;
          // });
          // if (foundReply>-1){
          //   self.replypossible = false;
          // }else{
          //   self.replypossible = true;            
          // }
        }

        console.log('-------> ITEMDATA CHANGED <--------');
        if (this.itemdata){
          console.log('------->',this.itemdata.dealstate,' <--------');
        }


        //this.startListener();
      },

      // startListener: function() {
      //   if (!this.itemid || !this.shhweb3) {
      //     return;
      //   }

      //   if (this.filter){
      //     this.filter.stopWatching();
      //   }
      
      //   var mytopics = [
      //     null,
      //     this.shhweb3.encodetopic(this.itemid)
      //   ];        

      //   this.filter = this.shhweb3.shh.filter({
      //     "topics": mytopics,
      //   });

      //   console.log("sc-itemdetail: start listening to", mytopics);
      //   this.filter.watch(this._processmessage.bind(this));

      // },

      // // processinging of channel setup messages.
      // _processmessage: function(error, result) {
      //   var self = this;
      //   //debugger;
      //   try {
      //     var payload = JSON.parse(self.shhweb3.toAscii(result.payload));
      //     console.log('incoming in whisperer: web3 ', result,self.shhweb3.toAscii(result.payload));
      //     switch (payload.type){
      //       case 'request-create':
      //         this.itemdata = payload;
      //         break;
      //       case 'request-reply':
      //         console.log('this is an item reply...');
      //         if (!this.replies){
      //           this.replies = [];
      //         }
      //         this.push('replies',payload);
      //         break;
      //       default:
      //         console.log('unknown payload type',payload.type);
      //         break;
      //     }
      //     //this.dispatch('add', payload);
      //     //this.push('deals',payload);
      //   } catch (e) {
      //     console.log(e);
      //   }
      // },


      ready: function() {
        //this.replypossible = true;
      },

      /**
       * 'onEnter' are the behaviors that occur when the router tells this component enters the stage 
       * use this to initialize any variables to start the component
       */
      onEnter: function() {},

      /**
       * 'onExit' are the behaviors that occur when the router tells this component to leave the stage 
       * use this to reset any variables when leaving this component while it remains loaded.
       */
      onExit: function() {},

      back: function() {
        this.fire('back');
      },

      // TEMP FUNCTION
      fireReplyselected: function(e) {
        var replydata = e.detail;
        this.fire('reply-selected', replydata);
      },

      firetoItemdetail: function() {
        console.log('WHaaaaaattt???');
        this.fire('reply-to-detail');
      },

      _log: function(target){
          console.log("HAZ THIS in item-detail??!!!!",target);
      },

//       _pubkeyCompare: function(){
// //        debugger;
//         if (this.identity.pubkey == this.itemdata.offererpubkey){
//           // console.log("yaaaaaaaaaaay!!!!", this.identity.pubkey,this.itemdata.offererpubkey);
//           this.youareowner = true;          
//         } else {
//           console.log("Nay, NO MATCH!!!!");
//           this.youareowner = false;          
//         }
//       },

      toMakeDeal: function(e){
        var self=this;
        var replydata = e.detail;
        //debugger;
        var message = {
            type: 'dealfortwo-select-provider',
            requestid: self.itemdata.id,
            replyid: replydata.id,
            timestamp: Date.now(),
          };


          var topics = [
            self.shhweb3.encodetopic('swarmcity-v1'),
            self.shhweb3.encodetopic(message.type),
            self.shhweb3.encodetopic(self.itemdata.hashtag),
            self.shhweb3.encodetopic(self.itemdata.id),
          ];

          var options = {
            "from": self.shhweb3.identity,
            "topics": topics,
            "payload": self.shhweb3.fromAscii(JSON.stringify(message)),
            "ttl": 60 * 60 * 24,
            "priority": 1000
          };

          console.log('posting to topics', topics);

          self.shhweb3.shh.post(options, function(err, res) {
            if (!err) {
              console.log(message.type,'-> Reply posted');
            } else {
              console.log(message.type,'-> whisper error:', err);
            }
          });



        this.fire('to-makedeal',e.detail);
      },

      _dealstate: function(target) {
        switch(target){
          case 'dealinit': 
            this.totalopacity = 'halfop';
            this.amountopacity = 'halfop';
          break;
          case 'dealcreated': 
            this.totalopacity = 'fullop';
            this.amountopacity = 'halfop';
          break;
          case 'dealfundedbyseeker': 
            this.totalopacity = 'fullop';
            this.amountopacity = 'fullop';
          break;
        }
      }

    });
  </script>
</dom-module>
